@model WFM.DAL.Quote

@{
    ViewBag.Title = "Quote";
    ViewBag.ButtonLink = "'/Quote/Details'";
}

<style>

    @@media screen {
        #printSection {
            display: none;
        }
    }

    @@media (min-width: 992px) {
        .modal-dialog {
            max-width: 60%;
        }
    }

    @@media print {
        body * {
            visibility: hidden;
        }

        #printSection, #printSection * {
            visibility: visible;
        }

        #printSection {
            position: absolute;
            left: 10px;
            top: 0;
        }
    }

    table.report-container {
        page-break-after: always;
    }

    thead.report-header {
        display: table-header-group;
    }

    tfoot.report-footer {
        display: table-footer-group;
    }

    tr {
        page-break-inside: avoid;
        page-break-after: auto
    }
</style>

<div class="dashboard-ecommerce">
    <div class="container-fluid dashboard-content ">
        <!-- ============================================================== -->
        <!-- pageheader  -->
        <!-- ============================================================== -->
        @Html.Partial("_PageHeaderPartialWithButton")
        <!-- ============================================================== -->
        <!-- end pageheader  -->
        <!-- ============================================================== -->
        <div class="border border-primary bg-actual-white  m-b-10">
            <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 m-t-20">
                <div class="table-responsive">
                    <table id="List" class="table table-striped table-bordered first">
                        <thead>
                            <tr>
                                <th>Code</th>
                                <th>Client</th>
                                <th>Header</th>
                                <th>Value</th>
                                <th>Created Date (DD/MM/YYYY)</th>
                                @*<th></th>*@
                                <th></th>
                                <th></th>
                                <th></th>
                                <th></th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="reportModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Print Quote</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="Preview">
                @Html.Partial("_PrintQuote")
            </div>
            <div class="modal-footer">
                <button id="btnPrint" type="button" class="btn btn-primary">Print</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" id="wayforwardModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Order Way Forward</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="Preview">
                <input type="hidden" id="QuoteId" />
                <input type="hidden" id="WayForward" />
                @*<input type="hidden" id="WayForwardNames" />*@
                <div class="row col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12">
                    @foreach (var division in ViewBag.Divisions)
                    {
                        <div class="col-xl-3 col-lg-3 col-md-12 col-sm-12 col-12 m-t-20">
                            <input type="checkbox" id="@division.Id" class="wayforward m-l-10" name="@division.Name" /> @division.Name
                        </div>
                    }
                    @*<input type="text" id="WayForwardNames" disabled="disabled" class="form-control" />*@
                    @*<div id="WayForwardNames"></div>*@
                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 m-t-20">
                        <textarea id="WayForwardNames" rows="3" cols="50" class="form-control" disabled="disabled"></textarea>
                    </div>
                </div>
                <div class="row col-xl-12 col-lg-12 col-md-12 col-sm-12 col-12 m-t-20">
                    <div class="col-xl-1 col-lg-1 col-md-6 col-sm-12 col-12 mb-2">
                        <label class="control-label" for="ArtWork">Art Work</label>
                    </div>
                    <div class="col-xl-5 col-lg-5 col-md-6 col-sm-12 col-12 mb-2">
                        <input type="file" id="ArtWork" name="ArtWork" class="form-control docs" />
                    </div>
                    <div class="col-xl-1 col-lg-1 col-md-6 col-sm-12 col-12 mb-2">
                        <label class="control-label" for="CustomerApproval">Customer Approval</label>
                    </div>
                    <div class="col-xl-5 col-lg-5 col-md-6 col-sm-12 col-12 mb-2">
                        <input type="file" id="CustomerApproval" name="CustomerApproval" class="form-control docs" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="btnConvert" type="button" class="btn btn-primary" onclick="ConvertQuote()">Convert</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        var wayforward = new Array();
        var wayforwardNames = new Array();
        $("#WayForward").val('');
        $("#WayForwardNames").val('');
        LoadQuotes();

        $(".wayforward").change(function () {

            wayforward = $("#WayForward").val().split(',');
            wayforwardNames = $("#WayForwardNames").val().split(' >> ');

            $("#WayForward").val('');
            $("#WayForwardNames").val('');

            if ($(this).prop("checked")) {
                wayforward.push($(this).prop("id"));
                wayforwardNames.push($(this).prop("name"));
            }
            else {
                wayforward.splice($.inArray($(this).prop("id"), wayforward), 1);
                wayforwardNames.splice($.inArray($(this).prop("name"), wayforwardNames), 1);
            }

            var wayforwardNew = wayforward.filter(function (el) {
                return el != null && el != "";
            });
            var wayforwardNamesNew = wayforwardNames.filter(function (el) {
                return el != null && el != "";
            });

            //alert(wayforwardNew);

            $.each(wayforwardNamesNew, function (index, value) {
                if ($("#WayForwardNames").val() == "")
                    $("#WayForwardNames").val(value);
                else {
                    $("#WayForwardNames").val($("#WayForwardNames").val() + " >> " + value.trim());
                }
            });
            //alert(wayforwardNamesNew);
            $("#WayForward").val(wayforwardNew);
            //$("#WayForwardNames").val(wayforwardNamesNew);
        });
    });

    document.getElementById("btnPrint").onclick = function () {
        printElement(document.getElementById("printThis"));
    }

    function printElement(elem) {
        var domClone = elem.cloneNode(true);

        var $printSection = document.getElementById("printSection");

        if (!$printSection) {
            var $printSection = document.createElement("div");
            $printSection.id = "printSection";
            document.body.appendChild($printSection);
        }

        $printSection.innerHTML = "";
        $printSection.appendChild(domClone);
        window.print();
    }

    function PrintQuote(id) {
        $.ajax({
            type: "GET",
            url: '@Url.Action("PrintQuote", "Quote")',
            data: { id: id },
            success: function (data) {
                $('#Preview').html(data);
                $('#reportModal').modal('show');
            }
        })
    }

    function WayForwardQuote(id) {
        $('#QuoteId').val(id);
        $('#wayforwardModal').modal('show');
    }

    function ApproveQuote(id) {
        if (confirm("Are you sure?")) {
            $.ajax({
                type: "GET",
                url: '@Url.Action("ApproveQuote", "Quote")',
                data: { id: id },
                success: function (data) {
                    LoadQuotes();
                }
            })
        }
    }

    function ConvertQuote() {
        id = $('#QuoteId').val();
        wayforward = $('#WayForward').val();

        var formData = new FormData();
        formData.append("id", id);
        formData.append("wayforward", wayforward);

        // Looping over all files and add it to FormData object
        var fileUpload = $("#ArtWork").get(0);
        var files = fileUpload.files;
        for (var i = 0; i < files.length; i++) {
            formData.append("ArtWork", files[i]);
        }

        fileUpload = $("#CustomerApproval").get(0);
        files = fileUpload.files;
        for (var i = 0; i < files.length; i++) {
            formData.append("CustomerApproval", files[i]);
        }

        $.ajax({
            url: '@Url.Action("ConvertQuote", "Quote")',
            data: formData,
            type: "POST",
            cache: false,
            async: false,
            processData: false,
            contentType: false,
            success: function (data) {
                $('#wayforwardModal').modal('hide');
                LoadQuotes();
            }
        })
    }

    function () {

        if ($.fn.dataTable.isDataTable('#List')) {
            table = $('#List').DataTable();
            table.destroy();
        }

        $('#List').DataTable({
            "ajax": {
                "url": "/Quote/GetList",
                "type": "POST",
                "datatype": "json"
            },
            "columnDefs": [
                { "className": "dt-center", "targets": "_all" }
            ],
            "columns": [
                { "data": "Code", "width": "10%" },
                { "data": "ClientName", "width": "30%" },
                { "data": "Header", "width": "20%" },
                { "data": "Value", "width": "10%" },
                { "data": "CreatedDateString", "width": "20%" },
                {
                    "data": "Id", "searchable": false, "ordering": false, "sorting": false,
                    "render": function (data, type, full, meta) {
                        if (full.IsApproved == true)
                            return '<a class="btn btn-success btn-xs" onclick="#" >Approved</a>';
                        else
                            return '<a class="btn btn-warning btn-xs" onclick="ApproveQuote(' + data + ')" >&nbsp;Approve&nbsp;</a>';
                    }
                },
                {
                    "data": "Id", "searchable": false, "ordering": false, "sorting": false,
                    "render": function (data, type, full, meta) {
                        return '<a class="btn btn-info btn-xs" onclick="PrintQuote(' + data + ')">View</a>';
                    }
                },
                {
                    "data": "Id", "searchable": false, "ordering": false, "sorting": false,
                    "render": function (data, type, full, meta) {
                         if(full.IsApproved == false)
                             return '<a class="btn btn-secondary btn-xs" href="/Quote/Details/' + data + '" target="_blank">&nbsp;&nbsp;&nbsp;Edit&nbsp;&nbsp;&nbsp;</a>';
                        else
                             return '<a class="btn btn-primary btn-xs" onclick="WayForwardQuote(' + data + ')" >Convert</a>';
                    }
                },
                {
                    "data": "Id", "searchable": false, "ordering": false, "sorting": false,
                    "render": function (data, type, full, meta) {
                        return '<a class="btn btn-danger btn-xs" href="/Quote/Archive/' + data + '" target="_blank">Archive</a>';
                    }
                },
            ]
        });

    }
</script>


@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
}
